name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1.2.0
        env:
          BRANCH: ${{ github.ref_name }}
          EC2_APP_DIR: ${{ secrets.EC2_APP_DIR }}
          EC2_HTTP_PORT: ${{ secrets.EC2_HTTP_PORT }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: BRANCH,EC2_APP_DIR,EC2_HTTP_PORT
          script: |
            set -euo pipefail

            if ! command -v docker >/dev/null 2>&1; then
              if command -v apt-get >/dev/null 2>&1; then
                sudo apt-get update
                sudo apt-get install -y docker.io
              elif command -v dnf >/dev/null 2>&1; then
                sudo dnf install -y docker
              elif command -v yum >/dev/null 2>&1; then
                sudo yum install -y docker
              else
                echo "Docker belum terinstall dan OS package manager tidak dikenali." >&2
                exit 1
              fi

              if command -v systemctl >/dev/null 2>&1; then
                sudo systemctl enable --now docker
              else
                sudo service docker start || true
              fi
            fi

            if [ -n "${EC2_APP_DIR:-}" ] && [ -f "$EC2_APP_DIR/waitlist/Dockerfile" ]; then
              ROOT_DIR="$EC2_APP_DIR"
            else
              ROOT_DIR=""
              for d in \
                "$HOME/Waitlist-landing-page" \
                "$HOME/waitlist-landing-page" \
                "/opt/Waitlist-landing-page" \
                "/srv/Waitlist-landing-page"
              do
                if [ -f "$d/waitlist/Dockerfile" ]; then
                  ROOT_DIR="$d"
                  break
                fi
              done
            fi

            if [ -z "$ROOT_DIR" ]; then
              echo "Repo tidak ketemu di EC2. Set secret EC2_APP_DIR ke folder root repo." >&2
              exit 1
            fi

            cd "$ROOT_DIR"
            git fetch --all --prune
            git checkout -B "$BRANCH" "origin/$BRANCH"
            git reset --hard "origin/$BRANCH"

            cd waitlist

            sudo docker build --target prod -t waitlist:latest .
            sudo docker stop waitlist || true
            sudo docker rm waitlist || true

            pick_port() {
              if [ -n "${EC2_HTTP_PORT:-}" ]; then
                echo "${EC2_HTTP_PORT}"
                return 0
              fi
              if sudo ss -ltnp "( sport = :80 )" 2>/dev/null | grep -q ":80"; then
                echo "8080"
              else
                echo "80"
              fi
            }

            PORT="$(pick_port)"

            CONTAINERS="$(sudo docker ps --filter "publish=$PORT" --format '{{.ID}}' || true)"
            if [ -n "$CONTAINERS" ]; then
              sudo docker stop $CONTAINERS || true
              sudo docker rm $CONTAINERS || true
            fi

            if sudo ss -ltnp "( sport = :$PORT )" 2>/dev/null | grep -q ":$PORT"; then
              echo "Port $PORT masih dipakai oleh service host. Set secret EC2_HTTP_PORT ke port lain (mis. 8080/3000) atau matikan service yang pakai port itu." >&2
              exit 1
            fi

            sudo docker run -d --restart unless-stopped --name waitlist -p "$PORT:80" waitlist:latest
            echo "Deployed: http://$(hostname -I 2>/dev/null | awk '{print $1}' || echo 'EC2_IP'):$PORT/"
